<div align='center' ><font size='70'>U家绘制户型(一)</font></div>

最近又开始对绘制户型这块功能进行迭代，趁着印象清晰赶紧把这部分功能整理记录下来。



## 基础

既然要绘制户型，那么用unity画程序网格自然是不可避免了，所以首先需要知道怎么样通过几个顶点来绘制三角面。网上教程很多就不在这里乱写了 (¬､¬) ，留个懒人链接：

https://catlikecoding.com/unity/tutorials/procedural-grid/

由于会出现不规则的面片（比如分开的地板，挖洞的墙壁等），所以还需要知道如何去生成这些面片，这个有些麻烦，参考一下网上大佬的算法：

https://www.geometrictools.com/Documentation/TriangulationByEarClipping.pdf



## 正文

### 墙

只有几堵墙体构成了一个封闭区间，才能判断他形成了一个空间，然后创建地板和天花板，所以绘制户型我们从画墙开始。

因为不会有人从地下向上看，所以我们的墙就只需要五个面就可以了（不要底面）。然后我们墙体厚度不允许改变，对于墙的两边只需要关心位置，以及当和别的墙连接时隐藏就行。

另外三个面等会再说，先看墙的整体。对于2D状态下来说，一堵墙其实就是一个线段，在两端生成两个圆形UI作为墙的两端顶点，两个圆的中心就是墙的位置，圆的距离就是墙的真实长度。在拖拽顶点圆时实时更新墙的长度和旋转，拖拽顶面时更新墙的位置，这样我们墙的生成与简单的控制就算是完成了。

现在我们生成两面墙将他们相接，如图

![wall2](C:\Users\Administrator\Desktop\blog\wall2.png)

这时，就需要将墙面补齐形成一个封闭区间，如2D图所示，定义两个顶点为point1和point2，两个顶点连成的线段顺时针旋转最近的墙和其对应方便区分。

![wall2D](C:\Users\Administrator\Desktop\blog\wall2D.png)

选择一堵墙的一个面来说（如下图中水平的这堵墙交点的顺时针面），两堵墙相交于点a，形成两个线段为ad和af，内角的两个面相交于点b。由于一堵墙的前后面是平行的，ab线段平分∠daf（证明省略）,可得∠bac = 90° -0.5 * ∠daf，ac是墙宽的一半，所以bc =  ac  * tan(∠bac)，得到b点位置。

![wallCull](C:\Users\Administrator\Desktop\blog\wallCull.png)

当多面墙相接时，只算一个角度显然不符合需求。每个重合的顶点需要求出所有相交的角度并作排序，得出顺时针和逆时针角度最小的两个角度，从而可以求出相对应面的交点位置。

这个时候，每道墙就应该有四个相交点，加上两个顶点，对这六个点顺时针排序就是我们所需要绘制的顶面墙的所有顶点了。